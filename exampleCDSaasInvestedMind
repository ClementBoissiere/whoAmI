# .github/workflows/deploy-prod.yml
name: ğŸš€ CD - Production Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch: # DÃ©ploiement manuel

jobs:
  deploy:
    name: ğŸŒ Deploy to Production
    runs-on: ubuntu-latest
    # âœ… Protection via branch rules et status checks GitHub

    environment: production # Protection branch

    # âš ï¸ Attendre que la CI frontend soit passÃ©e AVANT de dÃ©ployer
    needs: []  # Sera rempli si la CI frontend a tournÃ©

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: 'investedMind_Front/package-lock.json'

      - name: ğŸ“¥ Try to restore frontend build from cache
        uses: actions/cache@v4
        id: frontend-cache
        with:
          path: investedMind_Front/dist
          key: frontend-build-${{ github.sha }}
        continue-on-error: true

      - name: ğŸ“¦ Create frontend build archive
        run: |
          if [ "${{ steps.frontend-cache.outputs.cache-hit }}" = "true" ]; then
            echo "âœ… Using cached frontend build from CI"
            tar -czf frontend-build.tar.gz -C investedMind_Front/dist/invested-mind .
          else
            echo "âš ï¸ No cache found, building locally..."
            cd investedMind_Front
            npm ci
            npm run build
            tar -czf ../frontend-build.tar.gz -C dist/invested-mind .
          fi

      - name: ğŸ”§ Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ“ Create env directory on server
        run: |
          ssh -p 2221 -o StrictHostKeyChecking=no ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} '
            mkdir -p ~/projets/investedmind/env
          '

      - name: ğŸ” Create production secrets file
        run: |
          ssh -p 2221 -o StrictHostKeyChecking=no ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} '
            cat > ~/projets/investedmind/.env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          LEMON_SQUEEZY_API_KEY=${{ secrets.LEMON_SQUEEZY_API_KEY }}
          LEMON_SQUEEZY_WEBHOOK_SECRET=${{ secrets.LEMON_SQUEEZY_WEBHOOK_SECRET }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
          BETTER_AUTH_SECRET=${{ secrets.BETTER_AUTH_SECRET }}
          FMP_API_KEY=${{ secrets.FMP_API_KEY }}
          EOF
          chmod 600 ~/projets/investedmind/.env
          '

      - name: ğŸ“¤ Upload code to server
        run: |
          rsync -avz --delete -e "ssh -p 2221" \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.env' \
            --exclude 'env/' \
            ./ ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }}:~/projets/investedmind/

      - name: ğŸ“¤ Upload frontend build
        run: |
          scp -P 2221 frontend-build.tar.gz ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }}:~/projets/investedmind/


      - name: ğŸ’¾ Backup current images
        run: |
          ssh -p 2221 -o StrictHostKeyChecking=no ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} '
            cd ~/projets/investedmind

            # CrÃ©er un timestamp unique pour ce dÃ©ploiement
            BACKUP_TAG="backup-$(date +%Y%m%d-%H%M%S)"
            echo "Creating backup with tag: $BACKUP_TAG"

            # Backup des images existantes (si elles existent)
            if docker image ls | grep -q "investedmind_backend"; then
              docker tag investedmind_backend "investedmind_backend:$BACKUP_TAG"
              echo "âœ… Backend image backed up"
            fi

            if docker image ls | grep -q "investedmind_dataprocessor"; then
              docker tag investedmind_dataprocessor "investedmind_dataprocessor:$BACKUP_TAG"
              echo "âœ… DataProcessor image backed up"
            fi


            # Sauvegarder le tag pour le rollback
            echo "$BACKUP_TAG" > /tmp/investedmind_backup_tag
          '

      - name: ğŸ—ï¸ Deploy application
        id: deploy
        run: |
          ssh -p 2221 -o StrictHostKeyChecking=no ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} '
            cd ~/projets/investedmind

            echo "ğŸ›‘ Stopping existing services..."
            docker-compose -f docker-compose.prod.yml down

            echo "ğŸ—ï¸ Building and starting services..."
            if ! docker-compose -f docker-compose.prod.yml up -d --build; then
              echo "âŒ Build failed!"
              exit 1
            fi

            echo "ğŸš€ Deploying frontend to Nginx..."
            sudo mkdir -p /var/www/investedmind/html
            cd ~/projets/investedmind

            echo "ğŸ” Debug: Frontend archive exists?"
            ls -la frontend-build.tar.gz || echo "âŒ No frontend archive found!"

            echo "ğŸ” Debug: Archive content preview:"
            tar -tzf frontend-build.tar.gz | head -10 || echo "âŒ Cannot read archive!"

            if [ -f "frontend-build.tar.gz" ]; then
              echo "ğŸ“¦ Extracting frontend..."
              mkdir -p /tmp/frontend-extract
              tar -xzf frontend-build.tar.gz -C /tmp/frontend-extract/

              echo "ğŸ” Debug: Extracted files:"
              ls -la /tmp/frontend-extract/

              echo "ğŸ“ Copying to web directory..."
              # Vider le dossier avant dÃ©ploiement
              sudo rm -rf /var/www/investedmind/html/*

              # Angular moderne : fichiers dans browser/
              if [ -d "/tmp/frontend-extract/browser" ]; then
                echo "ğŸ”§ Angular modern build detected - extracting from browser/"
                sudo cp -r /tmp/frontend-extract/browser/* /var/www/investedmind/html/
              else
                echo "ğŸ”§ Legacy Angular build - copying directly"
                sudo cp -r /tmp/frontend-extract/* /var/www/investedmind/html/
              fi

              sudo chown -R www-data:www-data /var/www/investedmind/html/
              sudo chmod -R 755 /var/www/investedmind/html/

              echo "âœ… Frontend deployed. Final check:"
              sudo ls -la /var/www/investedmind/html/

              rm -rf /tmp/frontend-extract
              rm -f frontend-build.tar.gz
            else
              echo "âŒ No frontend build found - creating placeholder"
              echo "<h1>InvestedMind - Deployment Error</h1><p>Frontend build not found</p>" | sudo tee /var/www/investedmind/html/index.html
              sudo chown -R www-data:www-data /var/www/investedmind/html/
            fi

            cd ~/projets/investedmind

            echo "â³ Waiting for services to be ready..."
            sleep 45

            echo "ğŸ©º Health checks..."
            docker-compose -f docker-compose.prod.yml ps
          '

      - name: ğŸ” Verify deployment with automatic rollback
        run: |
          ssh -p 2221 -o StrictHostKeyChecking=no ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} '
            cd ~/projets/investedmind

            ROLLBACK_NEEDED=false
            BACKUP_TAG=$(cat /tmp/investedmind_backup_tag 2>/dev/null || echo "")

            echo "ğŸ” Running deployment verification..."

            # Test 1: VÃ©rifier que tous les services sont up et healthy
            echo "Test 1: Services status..."
            if ! docker-compose -f docker-compose.prod.yml ps | grep -E "(healthy|Up)" > /dev/null; then
              echo "âŒ Some services are not running properly"
              ROLLBACK_NEEDED=true
            else
              echo "âœ… All services are running"
            fi

            # Test 2: Health check de l API backend (direct sur port 3000)
            echo "Test 2: Backend API health..."
            for i in {1..5}; do
              if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "âœ… Backend API is healthy"
                break
              elif [ $i -eq 5 ]; then
                echo "âŒ Backend API health check failed after 5 attempts"
                ROLLBACK_NEEDED=true
              else
                echo "â³ Attempt $i/5 failed, retrying in 10s..."
                sleep 10
              fi
            done

            # Test 3: VÃ©rifier que le DataProcessor fonctionne
            echo "Test 3: DataProcessor status..."
            if ! docker-compose -f docker-compose.prod.yml ps dataprocessor | grep -q "Up"; then
              echo "âŒ DataProcessor is not running"
              ROLLBACK_NEEDED=true
            else
              echo "âœ… DataProcessor is running"
            fi

            # Test 4: VÃ©rifier que Nginx systÃ¨me sert le frontend
            echo "Test 4: Frontend via Nginx..."
            echo "ğŸ” Debug: Checking Nginx status..."
            sudo systemctl status nginx --no-pager -l || true
            echo "ğŸ” Debug: Testing local nginx..."
            curl -I http://localhost || true
            echo "ğŸ” Debug: Testing domain..."
            curl -I https://investedmind.com || true

            if ! curl -f https://investedmind.com > /dev/null 2>&1; then
              echo "âŒ Frontend not accessible via Nginx"
              echo "ğŸ” Nginx error logs:"
              sudo tail -10 /var/log/nginx/error.log || true
              ROLLBACK_NEEDED=true
            else
              echo "âœ… Frontend accessible via Nginx"
            fi

            # ğŸ”™ ROLLBACK SI NÃ‰CESSAIRE
            if [ "$ROLLBACK_NEEDED" = true ]; then
              echo "ğŸš¨ ROLLBACK TRIGGERED - Deployment failed verification"

              if [ -n "$BACKUP_TAG" ]; then
                echo "ğŸ”„ Rolling back to previous version ($BACKUP_TAG)..."

                # ArrÃªter les services dÃ©faillants
                docker-compose -f docker-compose.prod.yml down

                # Restaurer les images de backup
                if docker image ls | grep -q "investedmind_backend:$BACKUP_TAG"; then
                  docker tag "investedmind_backend:$BACKUP_TAG" investedmind_backend
                  echo "âœ… Backend image restored"
                fi

                if docker image ls | grep -q "investedmind_dataprocessor:$BACKUP_TAG"; then
                  docker tag "investedmind_dataprocessor:$BACKUP_TAG" investedmind_dataprocessor
                  echo "âœ… DataProcessor image restored"
                fi


                # RedÃ©marrer avec les anciennes images
                docker-compose -f docker-compose.prod.yml up -d

                # VÃ©rifier que le rollback fonctionne (test direct backend)
                sleep 30
                if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
                  echo "âœ… Rollback successful - Previous version restored"
                else
                  echo "âŒ Rollback failed - Manual intervention required"
                fi
              else
                echo "âŒ No backup available - Manual intervention required"
              fi

              exit 1
            else
              echo "ğŸ‰ Deployment successful - All tests passed!"
            fi
          '

      - name: ğŸ§¹ Cleanup old InvestedMind images only
        if: success()
        run: |
          ssh -p 2221 -o StrictHostKeyChecking=no ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} '
            echo "ğŸ§¹ Cleaning up old InvestedMind images..."

            # Nettoyer seulement les images backup de plus de 7 jours
            docker images --format "table {{.Repository}}:{{.Tag}}\t{{.CreatedAt}}" | \
            grep "investedmind.*backup-" | \
            awk '\''$2 ~ /[0-9]{8}-[0-9]{6}/ {
              cmd = "date -d \"7 days ago\" +%Y%m%d"
              cmd | getline cutoff
              close(cmd)
              split($2, date_parts, "-")
              if (date_parts[1] < cutoff) {
                print $1
              }
            }'\'' | \
            xargs -r docker rmi

            # Nettoyer les images danglings avec le label investedmind
            docker image prune -f --filter "label=project=investedmind"

            # Nettoyer les containers arrÃªtÃ©s du projet
            docker container prune -f --filter "label=project=investedmind"

            echo "âœ… Cleanup completed - Only InvestedMind resources cleaned"
          '

      - name: ğŸ“Š Deployment Summary
        if: success()
        run: |
          ssh -p 2221 -o StrictHostKeyChecking=no ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} '
            cd ~/projets/investedmind

            echo "ğŸ“Š DEPLOYMENT SUMMARY"
            echo "===================="
            echo "âœ… Commit: ${{ github.sha }}"
            echo "âœ… Timestamp: $(date)"
            echo "âœ… All services status:"
            docker-compose -f docker-compose.prod.yml ps

            echo ""
            echo "ğŸ”— Health checks:"
            curl -s http://localhost:3000/api/health || echo "âŒ Backend health check failed"
            curl -s https://investedmind.com/api/health || echo "âŒ Frontend proxy health check failed"
          '